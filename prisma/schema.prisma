// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- 1. AUTH & USER MODELS ---

model User {
  id              String        @id @default(cuid())
  name            String?
  email           String        @unique
  hashedPassword  String?
  image           String?
  emailVerified   DateTime?
  accounts        Account[]
  role            UserRole      @default(STUDENT)
  
  // Status for deactivation
  isActive        Boolean       @default(true) 
  
  // Last seen (for analytics)
  lastLogin       DateTime?     @default(now())

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // --- SaaS Relations ---
  organizationId  String?
  organization    Organization? @relation("OrgMembers", fields: [organizationId], references: [id], onDelete: SetNull) 
  
  // NEW: Hierarchy within Org
  orgRole         OrgRole       @default(MEMBER) 

  ownedOrganization Organization? @relation("OrgOwner")
  
  // A user (Student) can have a subscription directly
  subscription    Subscription? 

  // Custom overrides (Admin can give specific perks to a specific user)
  // e.g. { "allowedExams": ["WAEC"], "extraTime": true }
  customLimits    Json?         

  quizAttempts    QuizAttempt[]
  orders          Order[]
  joinRequests    JoinRequest[]
  
  // NEW: Relation to ExamPapers created by this user
  createdPapers   ExamPaper[]
  
  // NEW: Needed for Transaction relation
  transactions    Transaction[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  @@unique([identifier, token])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  
  // NEW: Optional slug for future use (made optional to support existing rows)
  slug      String?  @unique

  ownerId   String   @unique
  owner     User     @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members   User[]   @relation("OrgMembers")
  
  // --- SaaS Relations ---
  subscription Subscription? 
  
  // Invites sent by this org
  invites      OrgInvite[]
  
  // Incoming join requests
  joinRequests JoinRequest[]

  questions Question[]
  
  // --- NEW: Relation to Subject & Exam ---
  subjects  Subject[] 
  exams     Exam[]    // Organizations can create their own exams
  
  // NEW: LMS Relations
  examPapers    ExamPaper[]
  assignments   Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrgInvite {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         InviteStatus @default(PENDING)
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
}

model JoinRequest {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         RequestStatus @default(PENDING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId]) // One request per user per org
}

// --- 2. BILLING & PLANS ---

model Plan {
  id            String   @id @default(cuid())
  name          String   
  description   String?
  price         Int      
  currency      String   @default("NGN")
  interval      PlanInterval 
  type          PlanType 
  features      Json 
  isActive      Boolean  @default(true)
  subscriptions Subscription[]
  orders        Order[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Subscription {
  id             String   @id @default(cuid())
  userId         String?  @unique 
  user           User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?  @unique 
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId         String
  plan           Plan     @relation(fields: [planId], references: [id])
  startDate      DateTime @default(now())
  endDate        DateTime? 
  isActive       Boolean  @default(true)
  providerSubId  String?  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Order {
  id             String      @id @default(cuid())
  userId         String      
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId         String
  plan           Plan        @relation(fields: [planId], references: [id])
  amount         Int
  currency       String
  status         OrderStatus @default(PENDING)
  reference      String      @unique 
  transaction    Transaction?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model Transaction {
  id             String   @id @default(cuid())
  orderId        String   @unique
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount         Int
  currency       String
  status         String   
  provider       String   
  providerRef    String   
  paymentDate    DateTime @default(now())
  
  // NEW: Back-relation to User (optional to fix migration error)
  userId         String?
  user           User?    @relation(fields: [userId], references: [id])
  
  updatedAt      DateTime @updatedAt @default(now()) // Added default for backfill
}

// --- 3. EXAM & CONTENT MODELS ---

model Exam {
  id          String   @id @default(cuid())
  name        String   @unique
  shortName   String   @unique 
  description String?
  duration    Int      @default(45) // Duration in minutes
  apiAliases  Json?    
  
  organizationId String?       
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  questions   Question[]
  quizAttempts QuizAttempt[]
  
  // NEW: Relation
  examPapers  ExamPaper[]
}

model Subject {
  id             String        @id @default(cuid())
  name           String        
  // Removed @unique to allow multi-tenancy names

  // New Fields
  apiSlugs       Json?         
  organizationId String?       
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  questions    Question[]
  quizAttempts QuizAttempt[]
  
  // NEW: Relation
  examPapers   ExamPaper[]
}

model Question {
  id          String    @id @default(cuid())
  text        String    @db.Text
  explanation String?   @db.Text
  
  // For AI Theory Grading
  markingGuide String?  @db.Text 
  
  // For AI Metadata (e.g. source image analysis)
  aiContext   Json?     
  
  sourceApi   String?   
  year        Int
  imageUrl    String? 
  
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  examId      String
  exam        Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  sectionId   String?
  section     Section?  @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  organizationId String? 
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  options     Option[]
  userAnswers UserAnswer[]
  tags        Tag[]     @relation("QuestionTags")
  type        QuestionType @default(OBJECTIVE)
  
  // NEW: LMS Fields
  order          Int?         @default(0)
  paperId        String?
  paper          ExamPaper?   @relation(fields: [paperId], references: [id])
  
  updatedAt      DateTime     @updatedAt @default(now())
  createdAt      DateTime     @default(now())
}

model Option {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean  @default(false)
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userAnswers UserAnswer[]
}

model Tag {
  id        String     @id @default(cuid())
  name      String     @unique
  questions Question[] @relation("QuestionTags")
}

model Section {
  id          String     @id @default(cuid())
  instruction String     @db.Text 
  passage     String?    @db.Text
  questions   Question[]
}

// --- 4. LMS: NEW MODELS ---

model ExamPaper {
  id             String   @id @default(cuid())
  title          String   
  
  // Metadata
  examId         String
  exam           Exam     @relation(fields: [examId], references: [id])
  subjectId      String?
  subject        Subject? @relation(fields: [subjectId], references: [id])
  year           Int?
  
  // Visibility & Ownership
  isVerified     Boolean  @default(false) 
  isPublic       Boolean  @default(false)
  
  authorId       String
  author         User     @relation(fields: [authorId], references: [id])
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  questions      Question[]
  assignments    Assignment[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Assignment {
  id              String           @id @default(cuid())
  
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id])
  
  paperId         String
  paper           ExamPaper        @relation(fields: [paperId], references: [id])
  
  // Scheduling
  startTime       DateTime
  endTime         DateTime
  durationMinutes Int
  
  status          AssignmentStatus @default(ACTIVE)
  
  results         QuizAttempt[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

// --- 5. PERFORMANCE MODELS ---

model QuizAttempt {
  id          String   @id @default(cuid())
  score       Int
  correct     Int
  total       Int
  timeTaken   Int
  createdAt   DateTime @default(now())
  year        Int
  mode        QuizMode @default(EXAM)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  examId      String
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // NEW: Link to Assignment
  assignmentId String?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  
  userAnswers UserAnswer[]
}

model UserAnswer {
  id                String  @id @default(cuid())
  quizAttemptId     String
  quizAttempt       QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  questionId        String
  question          Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // For Objective
  selectedOptionId  String?
  option            Option?     @relation(fields: [selectedOptionId], references: [id], onDelete: Cascade)
  
  // For Theory
  textAnswer        String?     @db.Text
  aiFeedback        String?     @db.Text

  isCorrect         Boolean
}

// --- 6. ENUMS ---

enum UserRole {
  STUDENT
  ORGANIZATION
  ADMIN
}

// NEW
enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum QuestionType {
  OBJECTIVE
  THEORY
}

// NEW
enum AssignmentStatus {
  ACTIVE
  ARCHIVED
}

enum PlanInterval {
  MONTHLY
  QUARTERLY
  BIANNUALLY
  YEARLY
  LIFETIME
}

enum PlanType {
  STUDENT
  ORGANIZATION
}

enum OrderStatus {
  PENDING
  SUCCESSFUL
  FAILED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum QuizMode {
  EXAM
  PRACTICE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}